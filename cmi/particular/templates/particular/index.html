{% extends 'base.html' %}

{% block content %}

<div class="container py-2">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <h2 class="fw-bold text-dark mb-3 mb-md-0">All Particulars</h2>
        
        <div class="row">

            <form method="post">
                {% csrf_token %}
                <div class="mb-3 row">
                    {% comment %} <label for="sectors" class="form-label fw-bold">Filter by Sectors</label> {% endcomment %}
                    <select class="form-select" id="sectors" name="sectors">
                        <option value="" selected disabled>-- Select a sector --</option>
                        {% for s in sectors %}
                        <option value={{s.id}}>{{s.name}}</option>
                        {% endfor %}
                        {% comment %} 
                        <option value="All">All</option>
                        <option value="Dam">Dam</option>
                        <option value="Irrigation">Irrigation</option>
                        <option value="WaterSupply">Water Supply</option> 
                        {% endcomment %}
                    </select>
                </div>
            </form>
        </div>
 
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div class="d-flex flex-wrap gap-2 w-full">
        {% comment %} <a href="{% url 'particular:create_particular' %}" class="btn btn-primary">
            + Add New Particular
        </a> {% endcomment %}

            <!-- Filter Form -->
        <form method="get" class="row g-3 mb-3">
            <div class="col-md-4">
                {% comment %} <label for="sector" class="form-label">Sector</label> {% endcomment %}
                <select id="sector" name="sector" class="form-select" onchange="this.form.submit()">
                    <option value="">All Sectors</option>
                    {% for s in sectors %}
                        <option value="{{ s.id }}" {% if request.GET.sector == s.id|stringformat:'s' %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                {% comment %} <label for="division" class="form-label">Division</label> {% endcomment %}
                <select id="division" name="division" class="form-select" onchange="this.form.submit()">
                    <option value="">All Divisions</option>
                    {% for d in divisions %}
                        <option value="{{ d.id }}" {% if request.GET.division == d.id|stringformat:'s' %}selected{% endif %}>
                         Division {{ d.code }}-{{ d.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>

            <!-- Add Particular Button -->
             <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#divisionModal">
                Add Division
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#particularModal">
                Add Particular
            </button>
            <button type="button" class="btn btn-primary text-white" onclick="openModal()">
                Import from CSV/XLSX
            </button>

            <a 
                href="{% url 'particular:update-instances' %}"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 inline-block"
            >
                Update Instances
            </a>
            
        </div>
        
    </div>

    

    {% if particulars %}
    <!-- Search -->
    <div class="input-group mb-3 shadow-sm">
        <input type="text" id="tableSearch" class="form-control" placeholder="Search particulars...">
        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
    </div>

    <!-- Table -->
    <div class="table-responsive shadow-sm rounded bg-white">
        <table class="table table-striped table-hover align-middle" id="particularsTable">
            <thead class="table-light">
                <tr>
                    <th>PID</th>
                    <th>Project Type</th>
                    <th>Division</th>
                    <th>Task</th>
                    <th>Element</th>
                    <th>Particular</th>
                    <th class="text-center">Required Instances</th>
                    <th class="text-center">Collected Instances</th>
                    <th class="text-center">Progress (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for particular in particulars %}
                <tr>
                    <td>{{ particular.pid }}</td>
                    <td>{{ particular.project_type.name }}</td>
                    <td>{{ particular.division.name }}</td>
                    <td>{{ particular.task }}</td>
                    <td>{{ particular.element }}</td>
                    <td>{{ particular.name }}</td>
                    <td class="text-center">{{ particular.required_instances }}</td>
                    <td class="text-center">{{ particular.collected_instances }}</td>
                    <td class="text-center">
                        <div class="progress" style="height: 6px;">
                            <div 
                                class="progress-bar bg-primary" 
                                role="progressbar" 
                                style="width: {{ particular.progress|floatformat:0 }}%;" 
                                aria-valuenow="{{ particular.progress|floatformat:0 }}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">{{ particular.progress|floatformat:2 }}%</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav class="mt-3">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

    {% else %}
    <p class="text-center text-muted fs-5">
        No particulars found. How about 
        <a href="{% url 'particular:create_particular' %}" class="text-primary fw-bold">creating one</a>?
    </p>
    {% endif %}
</div>

{% comment %} Add division MOdal {% endcomment %}
<!-- Add division Modal -->
 <div id="divisionModal" class="modal fade" tabindex="-2" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <form id="division-form" method="POST" action="{% url 'particular:create-division' %}">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Create Division</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick='closeDivisionModal' aria-label="Close"></button>
                </div>
                <div class="m-3">

                {{division_form.as_p}}
                </div>
                
            </form>

            <div class="modal-footer">
            <button class="btn btn-primary" type="submit"> Add Division </button>
            <button class="btn btn-primary" id='division-clear' type="cancel" onclick="clearDivisionForm()"> Clear </button>
        </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="importForm" method="POST" action="{% url 'particular:import_from_file' %}" enctype="multipart/form-data" >
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Import Particulars from CSV/XLSX</h5>
                    <button type="button" class="btn-close" onclick="closeModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select File</label>
                        <input type="file" class="form-control" name="csv_file" id="csv_file" accept=".csv, .xlsx, .xls">
                    </div>


                    <div id="loadingSpinner" class="d-none text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Importing your file...</p>
                    </div>

                    {% if error %}
                    <div class="alert alert-danger py-2">{{ error }}</div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" id="importBtn" class="btn btn-primary" >Import</button>
                </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Add particular Modal -->
<div class="modal fade" id="particularModal" tabindex="-1" aria-labelledby="particularModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="particularModalLabel">Create New Particular</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="createParticularForm" method="post" action="{% url 'particular:create_particular' %}">
          {% csrf_token %}

          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <strong>Oops!</strong> {{ form.non_field_errors }}
          </div>
          {% endif %}

          {% for field in particular_form %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">
                {{ field.label }}
                {% if field.field.required %}
                  <span class="text-danger">*</span>
                {% endif %}
              </label>
              {{ field }}
              {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          {% endfor %}

          <!-- Modal Footer with Actions -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Particular</button>
          </div>
        </form>
      </div>
      
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
    
    // constants
    
    const divisionForm = document.getElementById('division-form');
    const cancel_button = document.getElementById('division-clear');
    const importBtn = document.getElementById('importBtn');
    
    
    const csvFile = document.getElementById('csv_file');
    const importForm = document.getElementById('importForm');
    // const importModal = new bootstrap.Modal(document.getElementById('importModal'));

    const modalBody = importForm.querySelector('.modal-body');
    const loadingSpinner = document.getElementById('loadingSpinner');


    
    // division modal
    function openDivisionModal() {
        new bootstrap.Modal(document.getElementById('divisionModal')).show();
    }

    //close division modal
    function closeDivisionModal() {
        divisionForm.reset();
        var divisionModal = bootstrap.Modal.getInstance(document.getElementById('divisionModal'));
        divisionModal.hide();
    }

    function clearDivisionForm() {
        closeDivisionModal();
    }

    // Modal control
    function openModal() {
        new bootstrap.Modal(document.getElementById('importModal')).show();
    }

    function closeModal() {
        var importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
        var spinner = document.getElementById('loadingSpinner');
        var importBtn = document.getElementById('importBtn');

        // importModal.hide();
        // clear any previsous error messages on closing the modal
        // Reset the form and the button state when the modal is closed
        document.getElementById('importForm').reset();

        spinner.classList.add('d-none');
        importBtn.disabled = false;
        importBtn.innerHTML = 'Import';
        
        // Hide the modal
        // importModal.hide();
        if (importModal) {
            importModal.hide();
        }
    }
   

    function importFile() {
        const csvFile = document.getElementById('csv_file');
        let importForm = document.getElementById('importForm');
        let loadingSpinner = document.getElementById('loadingSpinner');

        const modalBody = importForm.querySelector('.modal-body');
        // Check if a file has been selected
        if (csvFile.files.length === 0) {
            // Display an error message if no file is selected
            if (!modalBody.querySelector('.alert-danger')) {
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger py-2';
                errorAlert.textContent = 'Please select a file to import.';
                modalBody.insertBefore(errorAlert, loadingSpinner);
            }

            return;
        }

            
        // show spinner
        loadingSpinner.classList.remove('d-none');

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

        setTimeout(() => {
            document.getElementById('importForm').submit();
        }, 50);
    }

    document.getElementById('importBtn').addEventListener('click', function() {
        const btn = this;
        const csvFile = document.getElementById('csv_file');
        let importForm = document.getElementById('importForm');
        let loadingSpinner = document.getElementById('loadingSpinner');
        const modalBody = importForm.querySelector('.modal-body');

        // Check if a file has been selected
        if (csvFile.files.length === 0) {
            // Display an error message if no file is selected
            if (!modalBody.querySelector('.alert-danger')) {
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger py-2';
                errorAlert.textContent = 'Please select a file to import.';
                modalBody.insertBefore(errorAlert, loadingSpinner);
            }

            return;
        }
        
        // show spinner
        loadingSpinner.classList.remove('d-none');

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

        setTimeout(() => {
            document.getElementById('importForm').submit();
        }, 50);
    });


   
    //function closeModal() {
    //    let modalEl = document.getElementById('importModal');
    //    let modal = bootstrap.Modal.getInstance(modalEl);
    //    modal.hide();
    // }
    {% if open_modal %}
    openModal();
    {% endif %}

    // Table Search
    document.getElementById('tableSearch')?.addEventListener('input', function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('#particularsTable tbody tr');
        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            row.style.display = rowText.includes(searchValue) ? '' : 'none';
        });
        paginateTable();
    });

    // Pagination
    const rowsPerPage = 5;
    let currentPage = 1;

    function paginateTable() {
        const rows = document.querySelectorAll('#particularsTable tbody tr');
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const paginationEl = document.getElementById('pagination');
        // paginationEl.innerHTML = '';

        // Hide rows not in current page
        rows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? '' : 'none';
        });

        // Build pagination
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                paginateTable();
            });
            paginationEl.appendChild(li);
        }
    }

    // paginateTable();
</script>

{% endblock %}
