{% extends 'base.html' %}

{% block content %}

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <h2 class="fw-bold text-dark mb-3 mb-md-0">All Particulars</h2>
        
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div class="d-flex flex-wrap gap-2 w-full">
        {% comment %} <a href="{% url 'particular:create_particular' %}" class="btn btn-primary">
            + Add New Particular
        </a> {% endcomment %}

            <!-- Filter Form -->
        <form method="get" class="row g-3 mb-3">
            <div class="col-md-4">
                {% comment %} <label for="sector" class="form-label">Sector</label> {% endcomment %}
                <select id="sector" name="sector" class="form-select" onchange="this.form.submit()">
                    <option value="">All Sectors</option>
                    {% for s in sectors %}
                        <option value="{{ s.id }}" {% if request.GET.sector == s.id|stringformat:'s' %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                {% comment %} <label for="division" class="form-label">Division</label> {% endcomment %}
                <select id="division" name="division" class="form-select" onchange="this.form.submit()">
                    <option value="">All Divisions</option>
                    {% for d in divisions %}
                        <option value="{{ d.id }}" {% if request.GET.division == d.id|stringformat:'s' %}selected{% endif %}>
                            {{ d.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>

            <!-- Add Particular Button -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#particularModal">
                Add Particular
            </button>
            <button type="button" class="btn btn-primary text-white" onclick="openModal()">
                Import from CSV/XLSX
            </button>
        </div>
        
    </div>

    

    {% if particulars %}
    <!-- Search -->
    <div class="input-group mb-3 shadow-sm">
        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
        <input type="text" id="tableSearch" class="form-control" placeholder="Search particulars...">
    </div>

    <!-- Table -->
    <div class="table-responsive shadow-sm rounded bg-white">
        <table class="table table-striped table-hover align-middle" id="particularsTable">
            <thead class="table-light">
                <tr>
                    <th>PID</th>
                    <th>Name</th>
                    <th>Division</th>
                    <th>Project Type</th>
                    <th>Task</th>
                    <th>Element</th>
                    <th class="text-center">Data Collection Days</th>
                    <th class="text-center">Collected Days</th>
                    <th class="text-center">Progress (%)</th>
                </tr>
            </thead>
            <tbody>
                {% for particular in particulars %}
                <tr>
                    <td>{{ particular.pid }}</td>
                    <td>{{ particular.name }}</td>
                    <td>{{ particular.division.name }}</td>
                    <td>{{ particular.project_type.name }}</td>
                    <td>{{ particular.task }}</td>
                    <td>{{ particular.element }}</td>
                    <td class="text-center">{{ particular.data_collection_days }}</td>
                    <td class="text-center">{{ particular.collected_days }}</td>
                    <td class="text-center">
                        <div class="progress" style="height: 6px;">
                            <div 
                                class="progress-bar bg-primary" 
                                role="progressbar" 
                                style="width: {{ particular.progress|floatformat:0 }}%;" 
                                aria-valuenow="{{ particular.progress|floatformat:0 }}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">{{ particular.progress|floatformat:2 }}%</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav class="mt-3">
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

    {% else %}
    <p class="text-center text-muted fs-5">
        No particulars found. How about 
        <a href="{% url 'particular:create_particular' %}" class="text-primary fw-bold">creating one</a>?
    </p>
    {% endif %}
</div>

<!-- Import Modal -->
<div id="importModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{% url 'particular:import_from_file' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Import Particulars from CSV/XLSX</h5>
                    <button type="button" class="btn-close" onclick="closeModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select File</label>
                        <input type="file" class="form-control" name="csv_file" id="csv_file" accept=".csv, .xlsx, .xls">
                    </div>

                    <div id="loadingSpinner" class="d-none text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Importing your file...</p>
                    </div>
                    {% if error %}
                    <div class="alert alert-danger py-2">{{ error }}</div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" id="importBtn" class="btn btn-primary">Import</button>
                </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Add particular Modal -->
<div class="modal fade" id="particularModal" tabindex="-1" aria-labelledby="particularModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="particularModalLabel">Create New Particular</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form id="importForm" method="post" action="{% url 'particular:create_particular' %}">
          {% csrf_token %}

          {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <strong>Oops!</strong> {{ form.non_field_errors }}
          </div>
          {% endif %}

          {% for field in particular_form %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">
                {{ field.label }}
                {% if field.field.required %}
                  <span class="text-danger">*</span>
                {% endif %}
              </label>
              {{ field }}
              {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          {% endfor %}

          <!-- Modal Footer with Actions -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Particular</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
    // Modal control
    function openModal() {
        new bootstrap.Modal(document.getElementById('importModal')).show();
    }

    document.getElementById('importBtn').addEventListener('click', function(event) {
        // Show the spinner and disable the button
        document.getElementById('loadingSpinner').classList.remove('d-none');
        document.getElementById('importBtn').disabled = true;
        document.getElementById('importBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        
        // Submit the form
        document.getElementById('importForm').submit();
    });

    function closeModal() {
        // Reset the form and the button state when the modal is closed
        document.getElementById('importForm').reset();
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('importBtn').disabled = false;
        document.getElementById('importBtn').innerHTML = 'Import';
        
        // Hide the modal
        var myModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
        myModal.hide();
        if (myModal) {
            myModal.hide();
        }
    }
   
    //function closeModal() {
    //    let modalEl = document.getElementById('importModal');
    //    let modal = bootstrap.Modal.getInstance(modalEl);
    //    modal.hide();
    // }
    {% if open_modal %}
    openModal();
    {% endif %}

    // Table Search
    document.getElementById('tableSearch')?.addEventListener('input', function () {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('#particularsTable tbody tr');
        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            row.style.display = rowText.includes(searchValue) ? '' : 'none';
        });
        paginateTable();
    });

    // Pagination
    const rowsPerPage = 5;
    let currentPage = 1;

    function paginateTable() {
        const rows = document.querySelectorAll('#particularsTable tbody tr');
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';

        // Hide rows not in current page
        rows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? '' : 'none';
        });

        // Build pagination
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                paginateTable();
            });
            paginationEl.appendChild(li);
        }
    }

    paginateTable();
</script>

{% endblock %}
